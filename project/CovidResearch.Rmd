---
title: "CovidResearch"
output:
  html_document: default
  pdf_document: default
---
## Install and load Libraries
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages('dplyr')
library(readr)
library(dplyr)
library(ggplot2)
library(ggthemes)
library(lubridate)
options(scipen=999)
```

## Import Data

```{r}
#Covid-19 Info
cov_general_data<- read_csv2("../datasets/COVID-19_aantallen_gemeente_per_dag.csv")
cov_hospital_data <- read_csv2("../datasets/COVID-19_ziekenhuisopnames.csv")
cov_performed_tests <- read_csv2("../datasets/COVID-19_uitgevoerde_testen.csv")
#Other info
res_count_per_province_nl <- read_csv2("../datasets/Bevolkings_aantallen_per_provincie.csv")
```

## Population per province compared to the positive tests, hospital admissions and deaths per province

```{r}
## lets first inspect the datasets
head(cov_general_data)
head(cov_hospital_data)
head(res_count_per_province_nl)
head(cov_performed_tests)
```

## Let's explain the relevant variables and why/how we are going to use them: (TO NEXT MEET UP)
## TODO: Uitleg geven van variables
## Cleaning, mutating and filtering data (LG 1)

```{r}
## Let's filter out the null values from cov_general_data where the province is null since we cant use those in our research
## TODO: Here filter out the null values from cov_general_data_clean

cov_general_data_clean <- filter(cov_general_data,!is.na(Province))
head(cov_general_data_clean)
```

```{r}
## Two names of provinces have been detected and we will use "Friesland" for the sake of consistency
## TODO: Rename the value 'Fryslân' to 'Friesland'
cov_general_data_clean <- cov_general_data_clean %>%
  mutate(Province = replace(Province, Province == "Fryslân", "Friesland"))
head(cov_general_data_clean)
```

```{r}
## Remove variables that we are not going to use from cov_general_data
## TODO: Here remove the unnecessary variables from cov_general_data
cov_general_data_clean$Security_region_code <- NULL
cov_general_data_clean$Security_region_name <- NULL
cov_general_data_clean$Version <- NULL
cov_general_data_clean$Municipal_health_service <- NULL
cov_general_data_clean$ROAZ_region <- NULL
cov_general_data_clean$Municipality_code <- NULL
cov_general_data_clean$Municipality_name <- NULL

head(cov_general_data_clean)
```

```{r}
## Filter null values out of the dataset cov_hospital_data_clean
## TODO: Here filter out the rows where the is Security_region_name not available
## Making a new cleaned tibble called cov_hospital_data_clean
cov_hospital_data_clean <- filter(cov_hospital_data, !is.na(Security_region_name))
head(cov_hospital_data_clean) 
```

```{r}
## Rename 'Fryslân' to 'Friesland' in cov_hospital_data
## TODO: Here rename 'Fryslân' to 'Friesland' for consistency sake.
cov_hospital_data_clean <- cov_hospital_data_clean %>%
  mutate(Security_region_name = replace(Security_region_name, Security_region_name == "Fryslân", "Friesland"))
head(cov_hospital_data_clean)

```

```{r}
## Combine security regions into their respective provinces to a province variable to better fit the resident count data for later.
## Sorted based off this article wiki https://en.wikipedia.org/wiki/Safety_region
## TODO: Create Sets categorizing the security regions into their respective provinces
# only these provinces are fragmented the others are fine.
overijssel_vr <- c("VR04","VR05")
gelderland_vr <- c("VR06","VR07","VR08")
north_holland_vr <- c("VR10","VR11","VR12","VR13","VR14")
south_holland_vr <- c("VR15","VR16","VR17","VR18")
north_brabant_vr <- c("VR20","VR21","VR22")
limburg_vr <- c("VR23","VR24")
## TODO: Here combine security regions into their respective province
cov_hospital_data_clean <- cov_hospital_data_clean %>%
  mutate(Province = case_when(
    Security_region_code %in% overijssel_vr ~ 'Overijssel',
    Security_region_code %in% gelderland_vr ~ 'Gelderland',
    Security_region_code %in% north_holland_vr ~ 'Noord-Holland',
    Security_region_code %in% south_holland_vr ~ 'Zuid-Holland',
    Security_region_code %in% north_brabant_vr ~ 'Noord-Brabant',
    Security_region_code %in% limburg_vr ~ 'Limburg',
    TRUE ~ Security_region_name))

head(cov_hospital_data_clean)
```


```{r}
## Remove variables that we are not going to use from cov_hospital_data_clean
## TODO: Here remove 'Municipality_code', 'Municipality_name', 'Security_region_code', Security_region_name from cov_hospital_data_clean
cov_hospital_data_clean$Municipality_name <- NULL
cov_hospital_data_clean$Municipality_code <- NULL
cov_hospital_data_clean$Security_region_code <- NULL
cov_hospital_data_clean$Security_region_name <- NULL

head(cov_hospital_data_clean)
```

```{r}
## Remove the pv tag from province
## fist rename the names to English
names(res_count_per_province_nl)[1] <- "Province"
names(res_count_per_province_nl)[2] <- "Period"
names(res_count_per_province_nl)[3] <- "Amount"
## Remove the (PV) tag from province
res_count_per_province_nl$Province = gsub('.{5}$', '', res_count_per_province_nl$Province)
## renaming for consistency
res_count_per_province_nl <- res_count_per_province_nl %>%
  mutate(Province = replace(Province, Province == "Fryslân", "Friesland"))

head(res_count_per_province_nl)
```

```{r}
## Rename 'Fryslân' to 'Friesland' in cov_performed_tests_clean
## TODO: Here rename 'Fryslân' to 'Friesland' for consistency sake.
cov_performed_tests_clean <- cov_performed_tests %>%
  mutate(Security_region_name = replace(Security_region_name, Security_region_name == "Fryslân", "Friesland"))

head(cov_performed_tests_clean)
```

```{r}
## Filter the dataset "Performed tests" to also group security regions
## TODO: Filter the dataset "Performed tests" to also group security regions
cov_performed_tests_clean <- cov_performed_tests_clean %>%
  mutate(Province = case_when(
    Security_region_code %in% overijssel_vr ~ 'Overijssel',
    Security_region_code %in% gelderland_vr ~ 'Gelderland',
    Security_region_code %in% north_holland_vr ~ 'Noord-Holland',
    Security_region_code %in% south_holland_vr ~ 'Zuid-Holland',
    Security_region_code %in% north_brabant_vr ~ 'Noord-Brabant',
    Security_region_code %in% limburg_vr ~ 'Limburg',
    TRUE ~ Security_region_name))

head(cov_performed_tests_clean)
```

```{r}
## Remove unused variables from the "Performed tests" dataset
cov_performed_tests_clean$Security_region_code <- NULL
cov_performed_tests_clean$Security_region_name <- NULL

head(cov_performed_tests_clean)
```

```{r}
## calculate the cumulative sum of all preformed tests and positive tests per date
cov_performed_tests_clean <- cov_performed_tests_clean %>%
  group_by(Date_of_statistics) %>%
  mutate(Total_tested_with_result = cumsum(Tested_with_result)) %>%
  mutate(Total_tested_positive = cumsum(Tested_positive))

head(cov_performed_tests_clean)
```

```{r}
## aggregate the Total_tested_with_result and Total_tested_positive to eventually get the total over time
total_cov_tests_by_date <- aggregate(cov_performed_tests_clean$Total_tested_with_result, list(cov_performed_tests_clean$Date_of_statistics), max)
head(total_cov_tests_by_date)

total_pos_cov_tests_by_date <- aggregate(cov_performed_tests_clean$Total_tested_positive, list(cov_performed_tests_clean$Date_of_statistics), max)
head(total_pos_cov_tests_by_date)
```

```{r}
## rename columms
names(total_cov_tests_by_date)[1] <- "Date_of_report"
names(total_cov_tests_by_date)[2] <- "Tests_done"
names(total_pos_cov_tests_by_date)[1] <- "Date_of_report"
names(total_pos_cov_tests_by_date)[2] <- "Positive_tests"

head(total_cov_tests_by_date)
head(total_pos_cov_tests_by_date)
```

```{r}
## combine the results one last time in seperate tables
total_cov_tests_by_date <- total_cov_tests_by_date %>%
  mutate(Total_tests_over_time = cumsum(Tests_done))

head(total_cov_tests_by_date)

total_pos_cov_tests_by_date <- total_pos_cov_tests_by_date %>%
  mutate(Total_positive_tests_over_time = cumsum(Positive_tests))

head(total_pos_cov_tests_by_date)
```

```{r}
##combine to one table by date
total_test_results_by_date <- merge(total_cov_tests_by_date, total_pos_cov_tests_by_date)

head(total_test_results_by_date)
```

```{r}
## add population numbers to the correct province in the performed tests dataset
merged_res_count_general_data <- merge(cov_performed_tests_clean, res_count_per_province_nl, by= c("Province", "Province"))

# remove not needed variables
merged_res_count_general_data$Period <- NULL

#rename population amount variable
merged_res_count_general_data <- merged_res_count_general_data %>% 
  rename( Resident_count = Amount)

# set duplicates to 0 for to make it easier to plot
merged_res_count_general_data$Resident_count[duplicated(merged_res_count_general_data$Resident_count)] <- 0

```

## Transforming and providing analysis on the data (LG 2)

```{r}
## Positive tests over time
## TODO: Create ggplot showing positive tests over time AND change graph labels + explain
cov_general_data_clean %>% ggplot(aes(x = Date_of_publication, y = Total_reported)) + 
  geom_line(color = "darkgreen") + 
  labs(title = "Total positive tests over time",
       subtitle = "Date of publication: This is the daily number of reports newly received by the RIVM.\nThe time period in which the report was submitted runs\nfrom 10.01 a.m. yesterday to 10.00 a.m. today.\n\nTotal reported: The number of new persons reported to the GGD who tested positive \nfor SARS-CoV-2 published by the RIVM on date of publication.\n\nFrom 2020-02-28 till 2022-03-29",
       y = "Total reported",
       x = "Date of publication") + 
  theme_fivethirtyeight() +
  theme(axis.title = element_text())

cov_general_data_clean %>% ggplot(aes(x = Province, y = Total_reported)) + 
  geom_bar(stat = "identity", fill = "blue") + coord_flip() + 
  labs(title = "Total positive tests over time",
       subtitle = "Province: Name of the province\n\nTotal reported: The number of people reported to the GGD \nwho tested positive for SARS-CoV-2 at the time of publication.\n\nFrom 2020-02-28 till 2022-03-29",
       y = "Total reported",
       x = "Province") + 
  theme_fivethirtyeight() +
  theme(axis.title = element_text())
```

```{r}
## Hospital admissions over time
## TODO: Create ggplot showing hospital admissions over time AND change graph labels + explain
cov_hospital_data_clean %>% ggplot(aes(x = Date_of_statistics, y = Hospital_admission)) + 
  geom_line(color = "darkgreen") + 
  labs(title = "Hospital admissions over time",
       subtitle = "Date of report: Number of people reported to the GGD who tested positive for SARS-CoV-2 \nat the time of publication.\n\nTotal admissions: Number of hospitalized COVID-19 patients reported by the GGD \nat the time of publication.\n\nFrom 2020-03-10 till 2022-03-10",
       y = "Total admissions",
       x = "Date of report") + 
  theme_fivethirtyeight() +
  theme(axis.title = element_text())

cov_hospital_data_clean %>% ggplot(aes(x = Province, y = Hospital_admission)) + 
  geom_bar(stat = "identity", fill = "blue") + coord_flip() + 
  labs(title = "Hospital admissions over time",
       subtitle = "Province: Name of the province.\n\nTotal admissions: Number of Hospitalized COVID-19 patients reported by the GGD \nat the time of publication.\n\nFrom 2020-03-10 till 2022-03-10",
       y = "Total admissions",
       x = "Province") + 
  theme_fivethirtyeight() +
  theme(axis.title = element_text())
```

```{r}
## Deceased over time
## TODO: Create ggplot showing deceased over time AND change graph labels + explain
cov_general_data_clean %>% ggplot(aes(x = Date_of_publication, y = Deceased)) + 
  geom_line(color = "darkgreen") + 
  labs(title = "Deceased over time",
       subtitle = "Date of publication: This is the daily number of reports newly received by the RIVM.\nThe time period in which the report was submitted runs\nfrom 10.01 a.m. yesterday to 10.00 a.m. today.\n\nDeceased: The number of deceased persons reported to the GGDs who tested positive \nfor SARS-CoV-2 on date of publication was published by the RIVM. \nThe actual number of SARS-CoV-2 positive persons is higher than the number of reports \nin the surveillance, because not all deceased persons are tested. This is because there \nis no mandatory reporting requirement for deaths of people with a positive test result.\n\nFrom 2020-02-28 till 2022-03-28",
       y = "Deceased",
       x = "Date of publication") + 
  theme_fivethirtyeight() +
  theme(axis.title = element_text())

cov_general_data_clean %>% ggplot(aes(x = Province, y = Deceased)) + 
  geom_bar(stat = "identity", fill = "blue") + coord_flip() + 
  labs(title = "Deceased over time",
       subtitle = "Province: Name of the province\n\nDeceased: The number of deceased persons reported to the GGDs who tested \npositive for SARS-CoV-2 on date of publication was published by the RIVM.\n\nFrom 2020-02-28 till 2022-03-28",
       y = "Deceased",
       x = "Province") + 
  theme_fivethirtyeight() +
  theme(axis.title = element_text())
```

```{r}
## Total performed tests over time
## TODO: Create ggplot showing performed tests over time AND change graph labels + explain
total_cov_tests_by_date %>% ggplot(aes(x = Date_of_report, y = Total_tests_over_time)) + 
  geom_col(color = "steelblue") +
  labs(title = "Total performed tests over time",
       subtitle = "The sum of all the reported Covid-19 tests done in the Netherlands over time",
       y = "Total performed tests",
       x = "Date of Report") + 
  theme_fivethirtyeight() +
  theme(axis.title = element_text())
```

```{r}
## Total performed tests and positive tests over time
## TODO: Create ggplot showing performed tests and positive tests over time AND change graph labels + explain
total_test_results_by_date %>% ggplot(aes(x = Date_of_report)) + 
  geom_col(aes(y = Total_tests_over_time), color= "steelblue") +
  geom_col(aes(y = Total_positive_tests_over_time), color= "firebrick1") +
  labs(title = "Total performed tests and positive tests over time",
       subtitle = "Cumulative performed and positive tests in the Netherlands over time\n\nRed: Positive tests\nBlue: Performed tests",
       x = "Date of Report",
       y = "Tests") + 
  theme_fivethirtyeight() +
  theme(axis.title = element_text())
```

```{r}
## Total performed tests compared to population per province
## TODO: Create ggplot showing performed tests compared to pop over time AND change graph labels + explain
ggplot(data = merged_res_count_general_data, aes(x = Province)) + 
  geom_bar(aes(y = Tested_with_result), stat = 'identity', fill = 'steelblue') +
  geom_bar(aes(y = Resident_count), stat = 'identity', fill = 'red') +
  coord_flip() + 
  labs(title = "Performed tests compared to the population\nper province",
       subtitle = "\nRed: Province population\nBlue: Performed tests in province\n",
       y = "Count",
       x = "Province") + 
  scale_y_continuous(n.breaks = 6) +
  theme_fivethirtyeight() +
  theme(axis.title = element_text())
```

```{r}
## Total performed tests and positive tests compared to population per province
## TODO: Create ggplot showing performed tests and positive tests compared to pop over time AND change graph labels + explain
ggplot(data = merged_res_count_general_data, aes(x = Province)) + 
  geom_bar(aes(y = Tested_with_result), stat = 'identity', fill = 'steelblue') +
  geom_bar(aes(y = Resident_count), stat = 'identity', fill = 'chartreuse3') +
  geom_bar(aes(y = Tested_positive), stat = 'identity', fill = 'darkorchid3') +
  coord_flip() + 
  labs(title = "Performed tests and positive tests\ncompared to the population per province",
       subtitle = "\nGreen: Province population\nBlue: Performed tests in province\nPurple: Positive tests in province\n",
       y = "Count",
       x = "Province") + 
  scale_y_continuous(n.breaks = 6) +
  theme_fivethirtyeight() +
  theme(axis.title = element_text())
```

## Regression (LG 3)

## Regression Jamie

## Regression Glenn

```{r}
# 1. Uitleggen wat je goal is.

# Goal: Find out the total deceased over total positive tests from Limburg
# What I want to find out is the total deceased over the total positive tests from the province Limburg, because I originate from this province and found it interesting to find this out

# 2. Je variabelen voorbereiden (waarom ga je ze gebruiken)
# Tested_positive
# Deceased
# Province (Limburg)
# Date of publication

# 3. Visualiseren van je variabelen

cov_general_data_lim <- cov_general_data_clean
cov_general_data_lim <- filter(cov_general_data_lim,Province=="Limburg")

total_deceased <- aggregate(cov_general_data_lim$Deceased, list(cov_general_data_lim$Date_of_publication), sum)
total_positive <- aggregate(cov_general_data_lim$Total_reported, list(cov_general_data_lim$Date_of_publication), sum)

names(total_deceased)[1] <- "Date_of_publication"
names(total_deceased)[2] <- "Deceased"
names(total_positive)[1] <- "Date_of_publication"
names(total_positive)[2] <- "Positive_tests"

finalReg <- merge(total_deceased, total_positive)

ggplot(finalReg, aes(Positive_tests, Deceased)) + geom_point() + geom_smooth(method="lm")

# 4. Regression zelf
summary(lm(Deceased~Positive_tests, data=finalReg))

par(mfrow=c(2,2))
plot(lm(finalReg$Deceased~finalReg$Positive_tests))

# 5. Uitleggen van de coefficients
# 6. Residuals Uitleggen
# 7. De conclusie waarom is het goed of juist slecht.
```