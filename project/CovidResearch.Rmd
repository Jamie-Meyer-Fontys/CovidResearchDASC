---
title: "CovidResearch"
output:
  html_document: default
  pdf_document: default
---
## Install and load Libraries
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages('dplyr')
library(readr)
library(dplyr)
library(ggplot2)
library(ggthemes)
library(lubridate)
options(scipen=999)
```

## Import Data

```{r}
#Covid-19 Info
cov_general_data<- read_csv2("../datasets/COVID-19_aantallen_gemeente_cumulatief.csv")
cov_hospital_data <- read_csv2("../datasets/COVID-19_ziekenhuisopnames.csv")
cov_performed_tests <- read_csv2("../datasets/COVID-19_uitgevoerde_testen.csv")
#Other info
res_count_per_province_nl <- read_csv2("../datasets/Bevolkings_aantallen_per_provincie.csv")
```

## Population per province compared to the positive tests, hospital admissions and deaths per province

```{r}
## lets first inspect the datasets
cov_general_data
cov_hospital_data
res_count_per_province_nl
```

## Let's explain the relevant variables and why/how we are going to use them: (TO NEXT MEET UP)
## TODO: Uitleg geven van variables
## Cleaning, mutating and filtering data (LG 1)
```{r}
## The first dataset (cov_general_data) has to be cleaned up, because it has missing values and only the latest report data needs to be filtered out.
## Let's first filter the data based on the latest publication we have
## TODO: Here filter the cov_general_data by the date of 10th of March, 2022
## create a new variable named 'cov_general_data_clean' which represents the filtered dataset that shows the date of report of 10th of March, 2022
# cov_general_data$Date_of_report <- as.Date(cov_general_data$Date_of_report, format="%m/%d/%y")
# cov_general_data_clean <- filter(cov_general_data, Date_of_report == "2022-3-10")
# cov_general_data_clean
```

```{r}
## Let's filter out the null values from cov_general_data where the province is null since we cant use those in our research
## TODO: Here filter out the null values from cov_general_data_clean

cov_general_data_clean <- filter(cov_general_data,!is.na(Province))
cov_general_data_clean
```

```{r}
## Two names of provinces have been detected and we will use "Friesland" for the sake of consistency
## TODO: Rename the value 'Fryslân' to 'Friesland'
cov_general_data_clean <- cov_general_data_clean %>%
  mutate(Province = replace(Province, Province == "Fryslân", "Friesland"))
cov_general_data_clean
```

```{r}
## Remove variables that we are not going to use from cov_general_data
## TODO: Here remove Municipality_name, Municipality_code and Hospital Admission from cov_general_data
cov_general_data_clean$Municipality_name <- NULL
cov_general_data_clean$Municipality_code <- NULL
cov_general_data_clean$Hospital_admission <- NULL

cov_general_data_clean
```

```{r}
## Filter null values out of the dataset cov_hospital_data_clean
## TODO: Here filter out the rows where the is Security_region_name not available
## Making a new cleaned tibble called cov_hospital_data_clean
cov_hospital_data_clean <- filter(cov_hospital_data, !is.na(Security_region_name))
cov_hospital_data_clean 
```

```{r}
## Rename 'Fryslân' to 'Friesland' in cov_hospital_data
## TODO: Here rename 'Fryslân' to 'Friesland' for consistency sake.
cov_hospital_data_clean <- cov_hospital_data_clean %>%
  mutate(Security_region_name = replace(Security_region_name, Security_region_name == "Fryslân", "Friesland"))
cov_hospital_data_clean

```

```{r}
## Combine security regions into their respective provinces to a province variable to better fit the resident count data for later.
## Sorted based off this article wiki https://en.wikipedia.org/wiki/Safety_region
## TODO: Create Sets categorizing the security regions into their respective provinces
# only these provinces are fragmented the others are fine.
overijssel_vr <- c("VR04","VR05")
gelderland_vr <- c("VR06","VR07","VR08")
north_holland_vr <- c("VR10","VR11","VR12","VR13","VR14")
south_holland_vr <- c("VR15","VR16","VR17","VR18")
north_brabant_vr <- c("VR20","VR21","VR22")
limburg_vr <- c("VR23","VR24")
## TODO: Here combine security regions into their respective province
cov_hospital_data_clean <- cov_hospital_data_clean %>%
  mutate(Province = case_when(
    Security_region_code %in% overijssel_vr ~ 'Overijssel',
    Security_region_code %in% gelderland_vr ~ 'Gelderland',
    Security_region_code %in% north_holland_vr ~ 'Noord-Holland',
    Security_region_code %in% south_holland_vr ~ 'Zuid-Holland',
    Security_region_code %in% north_brabant_vr ~ 'Noord-Brabant',
    Security_region_code %in% limburg_vr ~ 'Limburg',
    TRUE ~ Security_region_name))

cov_hospital_data_clean
```


```{r}
## Remove variables that we are not going to use from cov_hospital_data_clean
## TODO: Here remove 'Municipality_code', 'Municipality_name', 'Security_region_code', Security_region_name from cov_hospital_data_clean
cov_hospital_data_clean$Municipality_name <- NULL
cov_hospital_data_clean$Municipality_code <- NULL
cov_hospital_data_clean$Security_region_code <- NULL
cov_hospital_data_clean$Security_region_name <- NULL

cov_hospital_data_clean
```

## JAMIE
```{r}
## Remove the pv tag from province
## fist rename the names to English
names(res_count_per_province_nl)[1] <- "Province"
names(res_count_per_province_nl)[2] <- "Period"
names(res_count_per_province_nl)[3] <- "Amount"
## Remove the (PV) tag from province
res_count_per_province_nl$Province = gsub('.{4}$', '', res_count_per_province_nl$Province)

res_count_per_province_nl
```
```{r}
## Rename 'Fryslân' to 'Friesland' in cov_preformed_tests
## TODO: Here rename 'Fryslân' to 'Friesland' for consistency sake.
cov_performed_tests <- cov_performed_tests %>%
  mutate(Security_region_name = replace(Security_region_name, Security_region_name == "Fryslân", "Friesland"))
cov_performed_tests

```

```{r}
## Filter the dataset "Performed tests" to also group security regions
## TODO: Filter the dataset "Performed tests" to also group security regions
cov_performed_tests <- cov_performed_tests %>%
  mutate(Province = case_when(
    Security_region_code %in% overijssel_vr ~ 'Overijssel',
    Security_region_code %in% gelderland_vr ~ 'Gelderland',
    Security_region_code %in% north_holland_vr ~ 'Noord-Holland',
    Security_region_code %in% south_holland_vr ~ 'Zuid-Holland',
    Security_region_code %in% north_brabant_vr ~ 'Noord-Brabant',
    Security_region_code %in% limburg_vr ~ 'Limburg',
    TRUE ~ Security_region_name))

cov_performed_tests
```

```{r}
## Remove unused variables from the "Performed tests" dataset
cov_performed_tests$Security_region_code <- NULL
cov_performed_tests$Security_region_name <- NULL
```

```{r}
## calculate the cumulative sum of all preformed tests per date
cov_performed_tests <- cov_performed_tests %>%
  group_by(Date_of_statistics)
  mutate(Total_tested_with_result = cumsum(Tested_with_result))

## aggergate the Total_tested_with_result to eventually get the total over time
total_cov_tests_by_date <- aggregate(cov_performed_tests$Total_tested_with_result, list(cov_performed_tests$Date_of_statistics), max)
total_cov_tests_by_date <- total_cov_tests_by_date

## rename columms
names(total_cov_tests_by_date)[1] <- "Date_of_report"
names(total_cov_tests_by_date)[2] <- "Tests_done"

total_cov_tests_by_date <- total_cov_tests_by_date %>%
  mutate(Total_tests_over_time = cumsum(Tests_done))
total_cov_tests_by_date
```

## Transforming and providing analysis on the data (LG 2)

## GLENN
```{r}
## Total positive tests over time
## TODO: Create ggplot showing positive tests over time AND change graph labels + explain
cov_general_data_clean %>% ggplot(aes(x = Date_of_report, y = Total_reported)) + 
  geom_line(color = "darkgreen") + 
  labs(title = "Positive tests over time",
       subtitle = "Date of report: Number of reports per day that were newly received by the RIVM,\n submitted from 10:01 a.m. yesterday to 10:00 a.m. today. \nThe publication date may differ from the date of the positive test result.\n\nTotal positive tested: The number of people reported to the GGD who tested positive\n for SARS-CoV-2 at the time of publication.\n\nFrom 2020-03-10 till 2022-03-10",
       y = "Total positive tested",
       x = "Date of report") + 
  theme_fivethirtyeight() +
  theme(axis.title = element_text())

cov_general_data_clean %>% ggplot(aes(x = Province, y = Total_reported)) + 
  geom_bar(stat = "identity", fill = "blue") + coord_flip() + 
  labs(title = "Positive tests over time",
       subtitle = "Province: Name of the province\n\nTotal positive tested: The number of people reported to the GGD \nwho tested positive for SARS-CoV-2 at the time of publication.\n\nFrom 2020-03-10 till 2022-03-10",
       y = "Total positive tested",
       x = "Province") + 
  theme_fivethirtyeight() +
  theme(axis.title = element_text())
```

```{r}
## Total hospital admissions over time
## TODO: Create ggplot showing hospital admissions over time AND change graph labels + explain
cov_hospital_data_clean %>% ggplot(aes(x = Date_of_statistics, y = Hospital_admission)) + 
  geom_line(color = "darkgreen") + 
  labs(title = "Hospital admissions over time",
       subtitle = "Date of report: Number of people reported to the GGD who tested positive for SARS-CoV-2 \nat the time of publication.\n\nTotal admissions: Number of hospitalized COVID-19 patients reported by the GGD \nat the time of publication.\n\nFrom 2020-03-10 till 2022-03-10",
       y = "Total admissions",
       x = "Date of report") + 
  theme_fivethirtyeight() +
  theme(axis.title = element_text())

cov_hospital_data_clean %>% ggplot(aes(x = Province, y = Hospital_admission)) + 
  geom_bar(stat = "identity", fill = "blue") + coord_flip() + 
  labs(title = "Hospital admissions over time",
       subtitle = "Province: Name of the province.\n\nTotal admissions: Number of Hospitalized COVID-19 patients reported by the GGD \nat the time of publication.\n\nFrom 2020-03-10 till 2022-03-10",
       y = "Total admissions",
       x = "Province") + 
  theme_fivethirtyeight() +
  theme(axis.title = element_text())
```

```{r}
## Total deceased over time
## TODO: Create ggplot showing deceased over time AND change graph labels + explain
cov_general_data_clean %>% ggplot(aes(x = Date_of_report, y = Deceased)) + 
  geom_line(color = "darkgreen") + 
  labs(title = "Total deceased over time",
       subtitle = "Date of report: Number of people reported to the GGD who tested positive for SARS-CoV-2 \nat the time of publication.\n\nDeceased: The number of deceased persons reported to the GGD who tested positive for \nSARS-CoV-2 at the time of publication. The actual number of deceased persons positive \nis higher than the number reported in surveillance \nbecause not all deceased persons are tested.\n\nFrom 2020-03-10 till 2022-03-10",
       y = "Deceased",
       x = "Date of report") + 
  theme_fivethirtyeight() +
  theme(axis.title = element_text())

cov_general_data_clean %>% ggplot(aes(x = Province, y = Deceased)) + 
  geom_bar(stat = "identity", fill = "blue") + coord_flip() + 
  labs(title = "Total deceased over time",
       subtitle = "Province: Name of the province\n\nTotal deceased: Number of deceased persons reported to the GGD who tested \npositive for SARS-CoV-2 at the time of publication. The actual number of \ndeceased persons positive is higher than the number reported in surveillance \nbecause not all deceased persons are tested.\n\nFrom 2020-03-10 till 2022-03-10",
       y = "Total deceased",
       x = "Province") + 
  theme_fivethirtyeight() +
  theme(axis.title = element_text())
```

## JAMIE
```{r}
## Total performed tests over time
## TODO: Create ggplot showing performed tests over time AND change graph labels + explain
total_cov_tests_by_date %>% ggplot(aes(x = Date_of_report, y = Total_tests_over_time)) + 
  geom_col(color = "darkgreen") +
  labs(title = "Total performed tests over time",
       subtitle = "",
       y = "Total performed tests",
       x = "Date of Report") + 
  theme_fivethirtyeight() +
  theme(axis.title = element_text())
```

```{r}
## Total performed tests and positive tests over time
## TODO: Create ggplot showing performed tests and positive tests over time AND change graph labels + explain
```

```{r}
## Total performed tests compared to population per province
## TODO: Create ggplot showing performed tests compared to pop over time AND change graph labels + explain
```

```{r}
## Total performed tests and positive tests compared to population per province
## TODO: Create ggplot showing performed tests and positive tests compared to pop over time AND change graph labels + explain
```

## Regression (LG 3)

## Regression Jamie

## Regression Glenn

```{r}
# attach(cov_general_data_clean)
##reg1 <- lm(formula = Total_reported ~ Deceased + I(Deceased^2), data=cov_general_data_clean)
# reg1 <- lm(formula = Total_reported ~ Deceased, data=cov_general_data_clean)
# 
# summary(reg1)
# plot(Deceased, Total_reported, main="Scatterplot")
# abline(reg1, col="red")
# ##cor(Deceased, I(Deceased^2))
# cor(Deceased, Total_reported)
# 
# reg1 <- lm(formula = Deceased ~ Total_reported, data=cov_general_data_clean)
# summary(reg1)
# plot(Total_reported, Deceased, main="Scatterplot")
# abline(reg1, col="red")
# cor(Total_reported, Deceased)

# x <- c(cov_general_data_clean$Total_reported)
# y <- c(cov_general_data_clean$Deceased)
# # relation <- lm(x~y)
# 
# plot(x,y,col = "blue",main = "Deceased over total reports",
# abline(lm(y~x)),cex = 1.3,pch = 16,xlab = "Total reports",ylab = "Deceased")
# 
# plot(y,x,col = "blue",main = "Deceased over total reports",
# abline(lm(x~y)),cex = 1.3,pch = 16,xlab = "Deceased",ylab = "Total reports")

# a <- data.frame(x)
# result <- predict(relation,a)

# print(summary(relation))
# print(result)

# plot(Deceased, Total_reported)
# plot(Total_reported, Deceased)

# eerste regression
cov_general_data_clean_reg <- cov_general_data_clean %>% group_by(month=floor_date(Date_of_report, "month")) %>%
   summarize(Deceased=sum(Deceased))

x <- c(cov_general_data_clean_reg$month)
y <- c(cov_general_data_clean_reg$Deceased)
relation <- lm(x~y)

plot(x,y,col = "blue",main = "Deceased per month (2020-3-13 | 2022-3-13)",
abline(lm(y~x)),cex = 1.3,pch = 16,xlab = "Month",ylab = "Deceased")

# tweede regression
cov_general_data_clean_reg <- cov_general_data_clean %>% group_by(month=floor_date(Date_of_report, "month")) %>%
   summarize(Total_reported=sum(Total_reported))

x <- c(cov_general_data_clean_reg$month)
y <- c(cov_general_data_clean_reg$Total_reported)
relation <- lm(x~y)

plot(x,y,col = "blue",main = "Total positive reports per month (2020-3-13 | 2022-3-13)",
abline(lm(y~x)),cex = 1.3,pch = 16,xlab = "Month",ylab = "Total positive reports")

```